#include <LoRa.h>
#include <SPI.h>
#include <WiFi.h>
#include <Wire.h>
#include <stdio.h>
#include "SSD1306.h"
#include "rom/ets_sys.h"
#include "soc/rtc_cntl_reg.h"
#include "soc/sens_reg.h"
#include <DHT.h>
#include <WiFiManager.h>

#define SCK  5 // GPIO5  -- SX1278's SCK
#define MISO 19 // GPIO19 -- SX1278's MISnO
#define MOSI 27 // GPIO27 -- SX1278's MOSI
#define SS   18 // GPIO18 -- SX1278's CS
#define RST  23 // GPIO14 -- SX1278's RESET
#define DI0  26 // GPIO26 -- SX1278's IRQ(Interrupt Request)
#define BAND 868E6 // LoRa band used
#define DHTTYPE DHT22 //Sensor used
#define pinDHT22 13 //DHTPin used on board
#define SSD1306_128_64

unsigned int counter = 0;
float temp;
float hum;
String NodeId = "GarageTemp"; //Friendly name for the device
String APName = NodeId + "AP"; // Creating the default AP name
DHT dhtsensor(pinDHT22, DHTTYPE);

SSD1306 display(0x3C, 21, 22);
WiFiManager wm; //initialising WiFimanager


// 'logo1-modified', 112x64px
const unsigned char my_bitmap_logo1_modified [] PROGMEM = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0xa0,0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x54,0xb5,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x95,
  0x4a,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x52,0x52,
  0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0xaa,0xaa,0x02,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xa0,0x4a,0x49,0x01,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x29,0x55,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x55,0x15,0x20,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x48,0x49,0x12,0x50,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x54,0xaa,0x0a,0x28,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0xa4,0xaa,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0xaa,0x92,0x00,0x8a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x94,0x54,0x00,0x84,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x52,0x15,0x00,0x45,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x2a,0x05,0x80,0x82,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x4a,0x01,0x40,0xa1,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x52,
  0x01,0x20,0xa0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x55,0x00,
  0xa0,0x90,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2a,0x00,0x48,
  0x50,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x10,0xa8,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x14,0x94,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0a,0xa4,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,0xaa,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x09,0x55,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x05,0x49,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x02,0x15,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0xa0,0x80,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x90,0x80,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x28,0x40,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x24,0xa0,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x2a,0x20,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x08,0x50,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0xfe,0x3f,0xfc,0x7f,0xfc,0xff,0x01,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0xab,0x2a,0x56,0xd5,0x54,0xd7,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x80,0x01,0x60,0x02,0x80,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x01,0x00,0x06,0x00,0x00,0x03,0xf8,0x3f,0xfe,0xff,0xc7,0xff,0x01,0x00,
  0x01,0x00,0x02,0x00,0x00,0x02,0x58,0x75,0xae,0xae,0xc6,0xaa,0x03,0x80,0x01,
  0x00,0x02,0x00,0x00,0x02,0x0c,0x20,0x02,0x04,0x4c,0x00,0x02,0x00,0x01,0x00,
  0x06,0x00,0x00,0x03,0x08,0x60,0x06,0x06,0xc4,0x00,0x02,0x00,0x01,0x3e,0x02,
  0xf8,0x00,0x02,0x0c,0x40,0x04,0x04,0x4c,0x00,0x03,0x80,0x01,0x34,0x06,0xa8,
  0x00,0x03,0xf8,0x77,0x06,0x0c,0xc8,0x00,0x02,0x00,0x01,0x60,0x02,0x80,0x00,
  0x02,0xac,0x5a,0x04,0x06,0x4c,0x00,0x02,0x00,0x01,0x20,0x06,0xc0,0x00,0x02,
  0x08,0x00,0x02,0x04,0x44,0x00,0x03,0x80,0x01,0x20,0x02,0x80,0x00,0x03,0x0c,
  0x00,0x06,0x04,0xcc,0x00,0x02,0x00,0x01,0x60,0x06,0x80,0x00,0x02,0x08,0x00,
  0x04,0x0c,0x44,0x00,0x03,0x00,0x6f,0x35,0x54,0xd5,0x00,0x03,0x58,0x55,0x06,
  0x06,0xcc,0x55,0x03,0x00,0xfb,0x1f,0xfc,0x7f,0x00,0x02,0xf8,0x3f,0x02,0x04,
  0xc4,0xff,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc0,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 
};


//read the temperature from the DHT22 sensor
void get_temperature_and_humidity() {  
   temp = dhtsensor.readTemperature();
   hum = dhtsensor.readHumidity();         
   if (isnan(temp) || isnan(hum)) {              // Check if any reads failed and exit early (to try again).
    Serial.println(F("Failed to read from DHT sensor!"));
    return;
   }  
}

//Blinkiing the onboard, green, LED
void blink_led() {
  digitalWrite(25, HIGH); // turn the green LED on (HIGH is the voltage level)
  delay(1000); // wait for a second  
  digitalWrite(25, LOW); // turn the green LED off by making the voltage LOW 
  return;
}

//Draw the information on the oled screen of the board for 1s
void present_sensor_info() {
  display.clear();
  display.setFont(ArialMT_Plain_10);
  display.setTextAlignment(TEXT_ALIGN_LEFT);  
  display.drawString(0, 0, "Sending packet: ");
  display.drawString(90, 0, String(counter));
  display.drawString(0, 12, String(NodeId));
  display.drawString(0, 24, "temp: " + String(temp) + " C");
  display.drawString(0, 36, "hum: " + String(hum) + " %");
  display.drawString(0, 48, "IP: " + String(WiFi.localIP().toString()));
  display.displayOn();
  display.display();
  delay(1000);
  display.displayOff();
}

//show logo on display
void present_logo() {  
  display.clear();
  display.displayOn();  
  display.drawXbm(0,0,112,64,my_bitmap_logo1_modified);  
  display.display();
  delay(30000);  
}

//send a string over LoRa interface
void transmit (String msg) {
  LoRa.beginPacket();
  LoRa.print(msg); // Send json string
  LoRa.endPacket();
  LoRa.print(msg);
  blink_led();
}

void setup() {  
  pinMode(25,OUTPUT); //Output for green LED
  pinMode(13,INPUT); //Input for DHT-sensor
  WiFi.mode(WIFI_STA);
  display.init();
  display.flipScreenVertically();
  present_logo();
  dhtsensor.begin();
  Serial.begin(115200);
  wm.setConfigPortalBlocking(false);
  wm.setConfigPortalTimeout(50000);
  if (wm.autoConnect((const char*)APName.c_str())) {
    Serial.println("connected to " + String(WiFi.SSID()));        
    display.clear();
    display.displayOn();
    display.drawString(0,45, String(WiFi.SSID()));
  }
  else {
    Serial.println("Configportal running");    
    display.clear();
    display.displayOn();
    display.drawString(0,45,"Loading Wifi");
  }
    
  while (!Serial)
    ;
  Serial.println();
  Serial.println("LoRa Sender Test");
  SPI.begin(SCK, MISO, MOSI, SS);
  LoRa.setPins(SS, RST, DI0);
  if (!LoRa.begin(BAND)) {
    Serial.println("Starting LoRa failed!");
    while (1)
      ;
  }

  Serial.println("init ok");  
  //delay(1500);
}

void loop() {
  
  wm.process();

  get_temperature_and_humidity();  
   
  String msg = "{\"name\":\"DHT_LoRa_Sensor\",\"id\":\"" + NodeId + "\",\"temperature\":" + String(temp) + ", \"humidity\":" + String(hum) +"}"; // Build json string to send
  transmit(msg); // Send json string
  Serial.println(msg); //print the json message to serial
  present_sensor_info();
  
  delay(5000); //wait for 5 second

  counter++;  
}